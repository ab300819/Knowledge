# 9.5 光盘写入工具

## 9.5.1 创建镜像

`mkisofs`

**制作一般数据镜像**

```
[root@study ~]# mkisofs [-o 映像檔] [-Jrv] [-V vol] [-m file] 待備份檔案... -graft-point isodir=systemdir ...
选项与参数：
-o ：后面接你想要产生的那个映像档档名。
-J ：产生较兼容于 windows 机器的文件名结构，可增加文件名长度到 64 个 unicode 字符
-r ：透过 Rock Ridge 产生支持 Unix/Linux 的文件数据，可记录较多的信息(如 UID/GID 等) ；
-v ：显示建置 ISO 文件的过程
-V vol ：建立 Volume，有点像 Windows 在文件总管内看到的 CD title 的东西
-m file ：-m 为排除文件 (exclude) 的意思，后面的文件不备份到映像档中，也能使用 * 通配符喔
-graft-point：graft 有转嫁或移植的意思，相关资料在底下文章内说明。
```

```
[root@study ~]# mkisofs -r -V 'linux_file' -o /tmp/system.img -m /root/etc -graft-point /root=/root /home=/home /etc=/etc

[root@study ~]# ll -h /tmp/system.img
-rw-r--r--. 1 root root 92M Jul 2 19:00 /tmp/system.img
# 上面的指令会建立一个大文件，其中 -graft-point 后面接的就是我们要备份的数据。
# 必须要注意的是那个等号的两边，等号左边是在映像文件内的目录，右侧则是实际的数据。

[root@study ~]# mount -o loop /tmp/system.img /mnt
[root@study ~]# ll /mnt

[root@study ~]# umount /mnt
```

**制作开机启动镜像**

```
# 1. 先观察一下这片光盘里面有啥东西？是否是我们需要的光盘系统！
[root@study ~]# isoinfo -d -i /home/CentOS-7-x86_64-Minimal-1503-01.iso
CD-ROM is in ISO 9660 format
System id: LINUX
Volume id: CentOS 7 x86_64
Volume set id:
Publisher id:
Data preparer id:
Application id: GENISOIMAGE ISO 9660/HFS FILESYSTEM CREATOR (C) 1993 E.YOUNGDALE (C) ...
Copyright File id:
.....(中間省略).....
    Eltorito defaultboot header:
        Bootid 88 (bootable)
        Boot media 0 (No Emulation Boot)
        Load segment 0
        Sys type 0
        Nsect 4

# 2. 开始挂载这片光盘到 /mnt ，并且将所有数据完整复制到 /srv/newcd 目录去喔
[root@study ~]# mount /home/CentOS-7-x86_64-Minimal-1503-01.iso /mnt
[root@study ~]# mkdir /srv/newcd
[root@study ~]# rsync -a /mnt/ /srv/newcd
[root@study ~]# ll /srv/newcd/
-rw-r--r--. 1 root root    16 Apr  1 07:11 CentOS_BuildTag
drwxr-xr-x. 3 root root    33 Mar 28 06:34 EFI
-rw-r--r--. 1 root root   215 Mar 28 06:36 EULA
-rw-r--r--. 1 root root 18009 Mar 28 06:36 GPL
drwxr-xr-x. 3 root root    54 Mar 28 06:34 images
drwxr-xr-x. 2 root root  4096 Mar 28 06:34 isolinux
drwxr-xr-x. 2 root root    41 Mar 28 06:34 LiveOS
drwxr-xr-x. 2 root root 20480 Apr  1 07:11 Packages
drwxr-xr-x. 2 root root  4096 Apr  1 07:11 repodata
-rw-r--r--. 1 root root  1690 Mar 28 06:36 RPM-GPG-KEY-CentOS-7
-rw-r--r--. 1 root root  1690 Mar 28 06:36 RPM-GPG-KEY-CentOS-Testing-7
-r--r--r--. 1 root root  2883 Apr  1 07:15 TRANS.TBL
# rsync 可以完整的复制所有的权限属性等数据，也能够进行镜像处理！相当好用的指令喔！
# 这里先了解一下即可。现在 newcd/ 目录内已经是完整的映像档内容！

# 3. 假设已经处理完毕你在 /srv/newcd 里面所要进行的各项修改行为，准备建立 ISO 檔！
[root@study ~]# ll /srv/newcd/isolinux/
-r--r--r--. 1 root root     2048 Apr  1 07:15 boot.cat      # 开机的型号数据等等
-rw-r--r--. 1 root root       84 Mar 28 06:34 boot.msg
-rw-r--r--. 1 root root      281 Mar 28 06:34 grub.conf
-rw-r--r--. 1 root root 35745476 Mar 28 06:31 initrd.img
-rw-r--r--. 1 root root    24576 Mar 28 06:38 isolinux.bin  # 相当于开机管理程序
-rw-r--r--. 1 root root     3032 Mar 28 06:34 isolinux.cfg
-rw-r--r--. 1 root root   176500 Sep 11  2014 memtest
-rw-r--r--. 1 root root      186 Jul  2  2014 splash.png
-r--r--r--. 1 root root     2438 Apr  1 07:15 TRANS.TBL
-rw-r--r--. 1 root root 33997348 Mar 28 06:33 upgrade.img
-rw-r--r--. 1 root root   153104 Mar  6 13:46 vesamenu.c32
-rwxr-xr-x. 1 root root  5029136 Mar  6 19:45 vmlinuz       # Linux 核心文件

[root@study ~]# cd /srv/newcd
[root@study newcd]# mkisofs -o /custom.iso -b isolinux/isolinux.bin -c isolinux/boot.cat \
> -no-emul-boot -V 'CentOS 7 x86_64' -boot-load-size 4 -boot-info-table -R -J -v -T .
```

## 9.5.2 光盘刻录

`cdrecord`

```
[root@study ~]# wodim --devices dev=/dev/sr0...               <==查询刻录机的 BUS 位置
[root@study ~]# wodim -v dev=/dev/sr0 blank=[fast|all]        <==抹除重复读写片
[root@study ~]# wodim -v dev=/dev/sr0 -format                 <==格式化 DVD+RW
[root@study ~]# wodim -v dev=/dev/sr0 [可用选项功能] file.iso
选项与参数：
--devices ：        用在扫瞄磁盘总线并找出可用的刻录机，后续的装置为 ATA 接口
-v ：               在 cdrecord 运作的过程中，显示过程而已。
dev=/dev/sr0 ：     可以找出此光驱的 bus 地址，非常重要！
blank=[fast|all]：  blank 为抹除可重复写入的 CD/DVD-RW，使用 fast 较快，all 较完整
-format ：          对光盘片进行格式化，但是仅针对 DVD+RW 这种格式的 DVD 而已；

[可用选项功能] 主要是写入 CD/DVD 时可使用的选项，常见的选项包括有：
    -data ：    指定后面的文件以数据格式写入，不是以 CD 音轨(-audio)方式写入！
    speed=X ：  指定刻录速度，例如 CD 可用 speed=40 为 40 倍数，DVD 则可用 speed=4 之类
    -eject ：   指定刻录完毕后自动退出光盘
    fs=Ym ：    指定多少缓冲存储器，可用在将映像档先暂存至缓冲存储器。预设为 4m，
                一般建议可增加到 8m ，不过，还是得视你的刻录机而定。

针对 DVD 的选项功能：
    driveropts=burnfree ：  打开 Buffer Underrun Free 模式的写入功能
    -sao ：                 支持 DVD-RW 的格式
```

**查看刻录机位置**

```
[root@study ~]# ll /dev/sr0
brw-rw----+ 1 root cdrom 11, 0 Jun 26 22:14 /dev/sr0 # 一般 Linux 光驱文件名

[root@study ~]# wodim --devices dev=/dev/sr0
-------------------------------------------------------------------------
 0  dev='/dev/sr0'      rwrw-- : 'QEMU' 'QEMU DVD-ROM'
-------------------------------------------------------------------------

[root@demo ~]# wodim --devices dev=/dev/sr0
wodim: Overview of accessible drives (1 found) :
-------------------------------------------------------------------------
 0  dev='/dev/sr0'      rwrw-- : 'ASUS' 'DRW-24D1ST'
-------------------------------------------------------------------------
```

**进行刻录**

```
# 0. 先抹除光盘的原始内容：(非可重复读写则可略过此步骤)
[root@demo ~]# wodim -v dev=/dev/sr0 blank=fast
# 中间会跑出一堆讯息告诉你抹除的进度，而且会有 10 秒钟的时间等待你的取消！

# 1. 开始刻录：
[root@demo ~]# wodim -v dev=/dev/sr0 speed=4 -dummy -eject /tmp/system.img
....(前面省略)....
Waiting for reader process to fill input buffer ... input buffer ready.
Starting new track at sector: 0
Track 01:   86 of   86 MB written (fifo 100%) [buf  97%]   4.0x.       # 这里有流程时间！
Track 01: Total bytes read/written: 90937344/90937344 (44403 sectors).
Writing  time:   38.337s                                               # 写入的总时间
Average write speed   1.7x.                                            # 换算下来的写入时间
Min drive buffer fill was 97%
Fixating...
Fixating time:  120.943s
wodim: fifo had 1433 puts and 1433 gets.
wodim: fifo was 0 times empty and 777 times full, min fill was 89%.
# 因为有加上 -eject 这个选项的缘故，因此刻录完成后，DVD 会被退出光驱喔！记得推回去！

# 2. 刻录完毕后，测试挂载一下，检验内容：
[root@demo ~]# mount /dev/sr0 /mnt
[root@demo ~]# df -h /mnt
Filesystem            Size  Used Avail Use% Mounted on
Filesystem      Size  Used Avail Use% Mounted on
/dev/sr0         87M   87M     0 100% /mnt

[root@demo ~]# ll /mnt
dr-xr-xr-x. 135 root root 36864 Jun 30 04:00 etc
dr-xr-xr-x.  19 root root  8192 Jul  2 13:16 root

[root@demo ~]# umount /mnt    <==不要忘了卸载
```