<!-- TOC -->

- [Linux 性能优化实战](#linux 性能优化实战)
    - [CPU 性能](#cpu 性能)
        - [平均负载](#平均负载)
        - [上下文切换](#上下文切换)
    - [内存性能](#内存性能)
    - [I/O 性能](#io 性能)
    - [网络性能](#网络性能)
    - [综合](#综合)

<!-- /TOC -->

# Linux 性能优化实战

## CPU 性能

### 平均负载

平均负载是指单位时间内，系统处于**可运行状态**和**不可中断状态**的平均进程数，也就是平均活跃进程数，它和 CPU 使用率并没有直接关系；分为 CPU 消耗，IO 消耗，CPU + IO 消耗。

可运行状态的进程，是指正在使用 CPU 或者正在等待 CPU 的进程，也就是 `ps` 命令看到的，处于 R 状态（Running 或 Runnable）的进程。

不可中断状态的进程则是正处于内核态关键流程中的进程，并且这些流程是不可打断的，比如最常见的是等待硬件设备的 I/O 响应，也就是在 `ps`  命令中看到的 D 状态（Uninterruptible Sleep，也称为 Disk Sleep）的进程。

理想服务器负载 = CPU 数量 * CPU 核心数量

假设服务器负载为 2，

- 在只有 2 个 CPU 的系统上，意味着所有的 CPU 都刚好被完全占用。
- 在 4 个 CPU 的系统上，意味着 CPU 有 50% 的空闲。
- 而在只有 1 个 CPU 的系统中，则意味着有一半的进程竞争不到 CPU。

> 当平均负载高于 CPU 数量 70% 的时候，就需要排查问题了

使用 `stress` 模拟几种负载高情况

```bash
# 模拟 CPU 密集型进程
stress --cpu 1 --timeout 600

# 模拟 I/O 密集型进程
stress -i 1 --timeout 600

# 模拟大量进程的场景
stress -c 8 --timeout 600
```

使用 `uptime` 观察系统平均负载

```bash
watch -d uptime
```

使用 `mpstat` 观察 CPU 使用率变化

```bash
# 显示所有CPU的指标，并在间隔5秒输出一组数据
mpstat -P ALL 5 1
```

使用 `pidstat` 观察哪个进程导致的

```bash
# 间隔5秒后输出一组数据
$ pidstat -u 5 1
```

### 上下文切换



## 内存性能

## I/O 性能

## 网络性能

## 综合

